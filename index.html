<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pesquisa de Validação — Completa</title>
  <style>
    :root{--bg:#0b0b0b;--card:#111;--muted:#9aa0a6;--accent:#00d4ff;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#e6eef3;background:linear-gradient(180deg,var(--bg),#050507)}
    .wrap{max-width:860px;margin:28px auto;padding:18px}
    header{display:flex;gap:12px;align-items:center}
    .logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7b61ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021}
    h1{margin:0;font-size:20px}
    p.lead{color:var(--muted);margin:6px 0 18px}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.6);margin-top:12px}
    label{display:block;margin-bottom:6px;font-weight:600}
    input[type=text],input[type=number],textarea,select{width:100%;padding:10px;border-radius:8px;border:none;background:#0b0b0b;color:#e6eef3;outline:1px solid rgba(255,255,255,0.05);margin-bottom:10px}
    .btn{background:var(--glass);border:1px solid rgba(255,255,255,0.08);padding:8px 14px;border-radius:10px;cursor:pointer;color:#e6eef3}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#7b61ff);color:#021;border:none}
    .small{font-size:13px;color:var(--muted)}
    #relatorio{margin-top:24px}
    canvas{background:#111;border-radius:12px;margin-top:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">PV</div>
      <div>
        <h1>Pesquisa de Validação</h1>
        <p class="lead">Formulário completo com todas as perguntas.</p>
      </div>
    </header>

    <main class="card">
      <form id="form">
        <label for="nome">Nome</label>
        <input type="text" id="nome" required placeholder="Seu nome" />

        <label for="idade">Idade</label>
        <input type="number" id="idade" required placeholder="Sua idade" min="10" max="120" />

        <label for="sexo">Sexo</label>
        <select id="sexo" required>
          <option value="">Escolha...</option>
          <option>Masculino</option>
          <option>Feminino</option>
          <option>Não informar</option>
        </select>

        <label for="servico">1. Qual tipo de serviço você costuma contratar?</label>
        <select id="servico" required>
          <option value="">Escolha...</option>
          <option>Reparos/Manutenção</option>
          <option>Limpeza/Serviços Domésticos</option>
          <option>Tecnologia/Design</option>
          <option>Consultoria/Mentoria</option>
          <option>Transporte/Logística</option>
          <option>Outro</option>
        </select>
        <input type="text" id="servico_outro" placeholder="Se 'Outro', escreva aqui" style="display:none" />

        <label for="criterio">2. O que mais pesa na sua decisão?</label>
        <select id="criterio" required>
          <option value="">Escolha...</option>
          <option>Preço</option>
          <option>Qualidade do trabalho</option>
          <option>Agilidade (Prazo/Rapidez)</option>
          <option>Atendimento/Suporte</option>
          <option>Outros</option>
        </select>
        <input type="text" id="criterio_outro" placeholder="Se 'Outros', escreva aqui" style="display:none" />

        <label for="dificuldade">3. Qual a principal dificuldade que você já teve?</label>
        <select id="dificuldade" required>
          <option value="">Escolha...</option>
          <option>O profissional não cumpriu o combinado</option>
          <option>Preço muito alto</option>
          <option>Falta de comunicação</option>
          <option>Outros</option>
        </select>
        <input type="text" id="dificuldade_outro" placeholder="Se 'Outros', escreva aqui" style="display:none" />

        <label for="acompanhamento">4. Como você prefere acompanhar o andamento do serviço?</label>
        <select id="acompanhamento" required>
          <option value="">Escolha...</option>
          <option>Acompanhando pessoalmente</option>
          <option>Recebendo atualizações do profissional</option>
          <option>Não acompanho, confio no profissional</option>
          <option>Outros</option>
        </select>
        <input type="text" id="acompanhamento_outro" placeholder="Se 'Outros', escreva aqui" style="display:none" />

        <label for="ambiental">5. O fator ambiental é importante para você?</label>
        <select id="ambiental" required>
          <option value="">Escolha...</option>
          <option>Sim, prefiro profissionais ecológicos</option>
          <option>Um pouco, mas não é decisivo</option>
          <option>Não, não considero esse fator</option>
        </select>

        <label for="suporte">6. O suporte após o serviço é importante para você?</label>
        <select id="suporte" required>
          <option value="">Escolha...</option>
          <option>Muito importante</option>
          <option>Mais ou menos importante</option>
          <option>Pouco importante</option>
          <option>Outros</option>
        </select>
        <input type="text" id="suporte_outro" placeholder="Se 'Outros', escreva aqui" style="display:none" />

        <label for="recomenda">7. Você recomendaria um bom profissional?</label>
        <select id="recomenda" required>
          <option value="">Escolha...</option>
          <option>Sim</option>
          <option>Talvez</option>
          <option>Não</option>
        </select>

        <button class="btn primary" type="submit">Salvar resposta</button>
      </form>
    </main>

    <div id="relatorio" class="card">
      <h2>Relatório de Respostas</h2>
      <canvas id="graficoServico" height="150"></canvas>
      <canvas id="graficoCriterio" height="150"></canvas>
      <canvas id="graficoDificuldade" height="150"></canvas>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://ztztpaawgkoykyhryycr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0enRwYWF3Z2tveWt5aHJ5eWNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNzU1MjksImV4cCI6MjA3MzY1MTUyOX0.OSaUaTkBSq5soALiDwDXqAwiGs4Afwg13QpPTlQWOv4';
    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const el = id => document.getElementById(id);

    function toggleInput(selectId, inputId) {
        el(selectId).addEventListener('change', e => {
            el(inputId).style.display = e.target.value === 'Outro' || e.target.value === 'Outros' ? 'block' : 'none';
        });
    }

    toggleInput('servico', 'servico_outro');
    toggleInput('criterio', 'criterio_outro');
    toggleInput('dificuldade', 'dificuldade_outro');
    toggleInput('acompanhamento', 'acompanhamento_outro');
    toggleInput('suporte', 'suporte_outro');

    const getVal = (selectId, inputId) => {
      const val = el(selectId).value;
      const otherVal = el(inputId).value.trim();
      return (val === 'Outro' || val === 'Outros') ? (otherVal || 'Outros') : val;
    };

    async function fetchDados() {
      const { data, error } = await supabase.from('respostas').select('*');
      if (error) { console.error(error); return []; }
      return data;
    }

    function contarRespostas(dados, campo) {
      return dados.reduce((acc, item) => {
        const key = item[campo] || 'Não informado';
        acc[key] = (acc[key] || 0) + 1;
        return acc;
      }, {});
    }

    function criarGrafico(ctx, labels, values, title) {
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: title,
            data: values,
            backgroundColor: 'rgba(0, 212, 255, 0.6)',
            borderColor: '#00d4ff',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });
    }

    async function atualizarRelatorio() {
      const dados = await fetchDados();
      if(dados.length === 0) return;
      el('relatorio').style.display = 'block';

      // Serviço
      const servicoCount = contarRespostas(dados, 'servico');
      criarGrafico(
        el('graficoServico'),
        Object.keys(servicoCount),
        Object.values(servicoCount),
        'Tipo de Serviço'
      );

      // Critério
      const criterioCount = contarRespostas(dados, 'criterio');
      criarGrafico(
        el('graficoCriterio'),
        Object.keys(criterioCount),
        Object.values(criterioCount),
        'Critério de Decisão'
      );

      // Dificuldade
      const dificuldadeCount = contarRespostas(dados, 'dificuldade');
      criarGrafico(
        el('graficoDificuldade'),
        Object.keys(dificuldadeCount),
        Object.values(dificuldadeCount),
        'Principais Dificuldades'
      );
    }

    el('form').addEventListener('submit', async e => {
      e.preventDefault();
      const dados = {
        nome: el('nome').value.trim(),
        idade: parseInt(el('idade').value),
        sexo: el('sexo').value,
        servico: getVal('servico', 'servico_outro'),
        criterio: getVal('criterio', 'criterio_outro'),
        dificuldade: getVal('dificuldade', 'dificuldade_outro'),
        acompanhamento: getVal('acompanhamento', 'acompanhamento_outro'),
        ambiental: el('ambiental').value,
        suporte: getVal('suporte', 'suporte_outro'),
        recomenda: el('recomenda').value
      };

      const { error } = await supabase.from('respostas').insert([dados]);
      if(error) { alert('Erro ao salvar resposta'); console.error(error); return; }

      alert('Resposta salva com sucesso!');
      e.target.reset();
      ['servico_outro','criterio_outro','dificuldade_outro','acompanhamento_outro','suporte_outro'].forEach(id => el(id).style.display='none');
      atualizarRelatorio();
    });

    // Carrega o relatório ao abrir a página
    atualizarRelatorio();
  </script>
</body>
</html>
